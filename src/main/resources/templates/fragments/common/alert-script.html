<th:block th:fragment="alert-script">
  <style>
    @keyframes flash {
      0% { background-color: #ffffff; }
      100% { background-color: #ffeaa7; }
    }

    @keyframes blink-animation {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }

    .blink {
      animation: blink-animation 1s infinite;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    window.addEventListener('load', () => {
      const icon = document.getElementById('notification-icon');
      const popup = document.getElementById('notification-popup');

      // âœ… ì•„ì´ì½˜ í´ë¦­ ì‹œ í•­ìƒ íŒì—… í‘œì‹œë˜ë„ë¡ ê¸°ë³¸ í•¸ë“¤ëŸ¬ ë“±ë¡
      if (icon && popup) {
        icon.addEventListener('click', () => {
          if (popup.innerHTML.trim() !== '') {
            // ê¸°ì¡´ ì•Œë¦¼ ë‚´ìš©ì´ ìˆë‹¤ë©´ ê·¸ëƒ¥ í† ê¸€
            popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
          } else {
            // ì•Œë¦¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì¶œë ¥
            popup.innerHTML = '<p>ğŸ”• ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            popup.style.display = 'block';
          }
        });
      }

      // âœ… SSE ì—°ê²°
      const eventSource = new EventSource('/sse/alerts');

      eventSource.addEventListener('ALERT', (event) => {
        const todos = JSON.parse(event.data);
        console.log("ğŸ“© ìˆ˜ì‹ ëœ ì•Œë¦¼:", todos);

        if (!Array.isArray(todos) || todos.length === 0) return;

        // âœ… ì•„ì´ì½˜ ê¹œë¹¡ì„
        if (icon) icon.classList.add('blink');

        // âœ… í™”ë©´ ì ë©¸
        document.body.style.animation = "flash 0.3s alternate 6";

        // âœ… ìŒì„± ì•Œë¦¼ (ì²« í´ë¦­ ì‹œë§Œ ì¬ìƒ)
        document.addEventListener('click', function handler() {
          const audio = new Audio('/sounds/alert.mp3');
          audio.play().catch(e => console.warn("ğŸ”‡ ìë™ ì¬ìƒ ì°¨ë‹¨:", e));
          document.removeEventListener('click', handler);
        });

        // âœ… íŒì—… ë‚´ìš© ê°±ì‹ 
        popup.innerHTML = todos.map(todo =>
            `<p>ğŸ• <strong>${todo.title}</strong><br/><span style="font-size: 12px;">ì‹œì‘ 10ë¶„ ì „ì…ë‹ˆë‹¤.</span></p>`
        ).join('');

        // íŒì—… ì—´ë ¤ìˆìœ¼ë©´ ìë™ ê°±ì‹ ëœ ë‚´ìš© ë³´ì´ë„ë¡ ìœ ì§€
        if (popup.style.display !== 'none') {
          popup.style.display = 'block';
        }
      });

      eventSource.addEventListener('CONNECTED', () => {
        console.log("âœ… SSE ì—°ê²°ë¨");
      });

      eventSource.onerror = (e) => {
        console.error("âŒ SSE ì—°ê²° ì˜¤ë¥˜:", e);
        eventSource.close();
      };
    });
    /*]]>*/
  </script>
</th:block>
