<th:block th:fragment="alert-script">
  <style>
    @keyframes flash {
      0%   { background-color: #ffffff; }
      100% { background-color: #ffeaa7; }
    }

    @keyframes blink-animation {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }

    .blink {
      animation: blink-animation 1s infinite;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const alertTodos = /*[[${alertTodos}]]*/ [];
    console.log("ðŸ”” alertTodos:", alertTodos);

    window.addEventListener('load', () => {
      const now = new Date();
      const icon = document.getElementById('notification-icon');
      const popup = document.getElementById('notification-popup');

      let shouldBlink = false;

      (alertTodos || []).forEach(todo => {
        if (!todo.startTime) return;
        const start = new Date(todo.startTime);
        const diffMin = (start.getTime() - now.getTime()) / 60000;

        console.log(`â±ï¸ ${todo.title}ê¹Œì§€ ${diffMin.toFixed(2)}ë¶„`);

        if (diffMin >= 0 && diffMin <= 10) {
          shouldBlink = true;
        }
      });

      // í™”ë©´ ì ë©¸ + ì•„ì´ì½˜ ê¹œë¹¡ìž„
      if (shouldBlink) {
        document.body.style.animation = "flash 0.3s alternate 6";

        if (icon) {
          icon.classList.add('blink');
          console.log("ðŸŸ  ì•„ì´ì½˜ ê¹œë¹¡ìž„ ì ìš©ë¨");
        }

        // ìŒì„± ì•Œë¦¼ (ì²« í´ë¦­ ì‹œ ìž¬ìƒ)
        document.addEventListener('click', function handler() {
          const audio = new Audio('/sounds/alert.mp3');
          audio.play().catch(e => console.warn("ðŸ”‡ ìžë™ ìž¬ìƒ ì°¨ë‹¨:", e));
          document.removeEventListener('click', handler);
        });

        // ì•„ì´ì½˜ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
        if (icon && popup) {
          icon.addEventListener('click', () => {
            popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
            console.log("ðŸŸ¡ íŒì—… í† ê¸€ë¨");
          });
        }
      }
    });
    /*]]>*/
  </script>
</th:block>
