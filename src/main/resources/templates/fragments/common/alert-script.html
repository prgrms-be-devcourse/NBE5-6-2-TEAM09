<th:block th:fragment="alert-script">
  <style>
    @keyframes flash {
      0% { background-color: #ffffff; }
      100% { background-color: #ffeaa7; }
    }

    @keyframes blink-animation {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }

    .blink {
      animation: blink-animation 1s infinite;
    }

    /* âœ… ìƒˆë¡œìš´ header êµ¬ì¡°ì— ë§ì¶˜ ìŠ¤íƒ€ì¼ */
    #notification-popup {
      display: none;
      position: absolute;
      top: 36px;
      right: 0;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0px 2px 12px rgba(0,0,0,0.15);
      width: 240px;
      z-index: 10000;
      max-height: 300px;
      overflow-y: auto;
    }

    #notification-popup p {
      margin: 0;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
      line-height: 1.4;
    }

    #notification-popup p:last-child {
      border-bottom: none;
    }

    /* âœ… ì•Œë¦¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    #notification-icon {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    #notification-icon:hover {
      transform: scale(1.1);
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    function setupNotificationScript() {
      // âœ… ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
      if (window.notificationSystemInitialized) {
        console.log("ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const icon = document.getElementById('notification-icon');
      const popup = document.getElementById('notification-popup');

      if (!icon || !popup) {
        console.warn("ğŸ”• ì•Œë¦¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        console.log("Icon:", icon, "Popup:", popup);
        return;
      }

      console.log("âœ… ì•Œë¦¼ ìš”ì†Œ ì°¾ìŒ:", { icon, popup });

      // âœ… í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      icon.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        console.log("ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ë¨");

        // í˜„ì¬ íŒì—… ìƒíƒœ í™•ì¸
        const isVisible = popup.style.display === 'block';

        if (isVisible) {
          popup.style.display = 'none';
          console.log("íŒì—… ìˆ¨ê¹€");
        } else {
          // íŒì—…ì— ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸
          if (popup.innerHTML.trim() === '') {
            popup.innerHTML = '<p>ğŸ”• ì•„ì§ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
          popup.style.display = 'block';
          console.log("íŒì—… í‘œì‹œ", popup.innerHTML);
        }
      });

      // âœ… ì™¸ë¶€ í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
      document.addEventListener('click', function(e) {
        if (!icon.contains(e.target) && !popup.contains(e.target)) {
          popup.style.display = 'none';
        }
      });

      // âœ… SSE ì—°ê²°
      let eventSource = null;

      try {
        // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ë‹«ê¸°
        if (window.notificationEventSource) {
          window.notificationEventSource.close();
        }

        eventSource = new EventSource('/sse/alerts');
        window.notificationEventSource = eventSource;

        eventSource.addEventListener('ALERT', function(event) {
          try {
            console.log("ğŸ“© SSE ì´ë²¤íŠ¸ ìˆ˜ì‹ :", event.data);

            const todos = JSON.parse(event.data);

            if (!Array.isArray(todos) || todos.length === 0) {
              console.log("ë¹ˆ ì•Œë¦¼ ë°ì´í„°");
              return;
            }

            console.log("ì²˜ë¦¬í•  ì•Œë¦¼:", todos);

            // âœ… ì‹œê°ì  íš¨ê³¼
            icon.classList.add('blink');
            document.body.style.animation = "flash 0.3s alternate 6";

            // âœ… ì‚¬ìš´ë“œ ì¬ìƒ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„)
            const playSound = function() {
              const audio = new Audio('/sounds/alert.mp3');
              audio.play().catch(e => console.warn("ğŸ”‡ ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨:", e));
              document.removeEventListener('click', playSound);
            };
            document.addEventListener('click', playSound, { once: true });

            // âœ… íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
            popup.innerHTML = todos.map(todo =>
                `<p>ğŸ• <strong>${todo.title}</strong><br/><span style="font-size: 12px; color: #666;">ì‹œì‘ 10ë¶„ ì „ì…ë‹ˆë‹¤.</span></p>`
            ).join('');

            // âœ… íŒì—… ìë™ í‘œì‹œ
            popup.style.display = 'block';

            // âœ… ê¹œë¹¡ì„ íš¨ê³¼ ì œê±°
            setTimeout(() => {
              icon.classList.remove('blink');
            }, 3000);

          } catch (error) {
            console.error("âŒ ì•Œë¦¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error, event.data);
          }
        });

        eventSource.addEventListener('CONNECTED', function() {
          console.log("âœ… SSE ì—°ê²° ì„±ê³µ");
        });

        eventSource.addEventListener('error', function(e) {
          console.error("âŒ SSE ì—°ê²° ì˜¤ë¥˜:", e);
          if (eventSource) {
            eventSource.close();
            window.notificationEventSource = null;
          }
        });

      } catch (error) {
        console.error("âŒ SSE ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
      }

      // âœ… ì´ˆê¸°í™” ì™„ë£Œ
      window.notificationSystemInitialized = true;
      console.log("âœ… ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ");
    }

    // âœ… DOM ì¤€ë¹„ í›„ ì‹¤í–‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupNotificationScript);
    } else {
      // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      setupNotificationScript();
    }

    // âœ… í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', function() {
      if (window.notificationEventSource) {
        window.notificationEventSource.close();
      }
    });
    /*]]>*/
  </script>
</th:block>