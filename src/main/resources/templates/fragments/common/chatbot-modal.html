<!-- chatbot-modal.html -->
<div th:fragment="chatbot">
  <style>
    .chatbot-modal {
      display: none;
      width: 400px;
      height: 500px;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 20px;
      font-family: 'Pretendard', sans-serif;
      flex-direction: column;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    }

    .chatbot-modal.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .chatbot-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: white;
      border: 2px solid #ccc;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      text-align: center;
      line-height: 56px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1001;
      transition: transform 0.2s ease;
    }

    .chatbot-button:hover {
      transform: scale(1.1);
    }

    .chatbot-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    .chatbot-input:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .chatbot-send-btn {
      margin-top: 8px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }

    .chatbot-send-btn:hover {
      background-color: #0056b3;
    }

    .chatbot-send-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .chatbot-response {
      max-height: 350px;
      overflow-y: auto;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
      line-height: 1.6;
      font-size: 14px;
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
    .chatbot-response h1, .chatbot-response h2, .chatbot-response h3 {
      margin: 16px 0 8px 0;
      color: #333;
      font-weight: 600;
    }

    .chatbot-response h1 { font-size: 18px; }
    .chatbot-response h2 { font-size: 16px; }
    .chatbot-response h3 { font-size: 15px; }

    .chatbot-response p {
      margin: 8px 0;
      color: #555;
    }

    .chatbot-response ul, .chatbot-response ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .chatbot-response li {
      margin: 4px 0;
      color: #555;
    }

    .chatbot-response code {
      background-color: #e9ecef;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #d63384;
    }

    .chatbot-response pre {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .chatbot-response pre code {
      background: none;
      padding: 0;
      color: #333;
    }

    .chatbot-response strong {
      font-weight: 600;
      color: #333;
    }

    .chatbot-response em {
      font-style: italic;
      color: #666;
    }

    .chatbot-response blockquote {
      border-left: 4px solid #007bff;
      margin: 8px 0;
      padding-left: 12px;
      color: #666;
      font-style: italic;
    }

    .loading-dots {
      display: inline-block;
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; }
    }
  </style>

  <!-- ì±—ë´‡ ë²„íŠ¼ -->
  <div id="chatbot-button" class="chatbot-button" onclick="toggleChatbot()">
    ğŸ¤–
  </div>

  <!-- ì±—ë´‡ ëª¨ë‹¬ wrapper -->
  <div id="chatbot-modal-wrapper" style="position: fixed; bottom: 100px; right: 30px; z-index: 1000;">
    <div id="chatbot-modal" class="chatbot-modal">
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <strong style="color: #333; font-size: 16px;">CodeMap ì±—ë´‡</strong>
        <button onclick="toggleChatbot()" style="
          border: none;
          background: transparent;
          font-size: 18px;
          cursor: pointer;
          color: #666;
          padding: 0;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
        ">âœ–</button>
      </div>

      <!-- ë‚´ìš© -->
      <div style="flex-grow: 1;">
        <div id="chatbot-response" class="chatbot-response">
          ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”. ğŸ¤–
        </div>
      </div>

      <!-- í•˜ë‹¨ ì…ë ¥ -->
      <div style="margin-top: 15px;">
        <input
            type="text"
            id="chatbot-input"
            class="chatbot-input"
            placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            maxlength="100"
        />
        <button id="chatbot-send-btn" class="chatbot-send-btn" onclick="sendKeywordFromInput()">
          ë³´ë‚´ê¸°
        </button>
      </div>
    </div>
  </div>

  <script>
    let isLoading = false;

    function toggleChatbot() {
      const modal = document.getElementById('chatbot-modal');
      if (modal.classList.contains('show')) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      } else {
        modal.style.display = 'flex';
        setTimeout(() => {
          modal.classList.add('show');
          // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
          document.getElementById('chatbot-input').focus();
        }, 10);
      }
    }

    // Enter í‚¤ ì²˜ë¦¬
    document.getElementById('chatbot-input').addEventListener('keypress', function(event) {
      if (event.key === 'Enter' && !isLoading) {
        event.preventDefault();
        sendKeywordFromInput();
      }
    });

    // ESC í‚¤ë¡œ ë‹«ê¸°
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('chatbot-modal');
        if (modal.classList.contains('show')) {
          toggleChatbot();
        }
      }
    });

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function (event) {
      const modal = document.getElementById('chatbot-modal');
      const wrapper = document.getElementById('chatbot-modal-wrapper');
      const button = document.getElementById('chatbot-button');
      if (modal.classList.contains('show') &&
          !wrapper.contains(event.target) &&
          !button.contains(event.target)) {
        toggleChatbot();
      }
    });

    // ì…ë ¥ì°½ì—ì„œ í‚¤ì›Œë“œ ì „ì†¡
    function sendKeywordFromInput() {
      const input = document.getElementById('chatbot-input');
      const keyword = input.value.trim();
      if (keyword && !isLoading) {
        sendKeyword(keyword);
        input.value = '';
      }
    }

    // ë¡œë”© ìƒíƒœ ì„¤ì •
    function setLoading(loading) {
      isLoading = loading;
      const sendBtn = document.getElementById('chatbot-send-btn');
      const input = document.getElementById('chatbot-input');

      if (loading) {
        sendBtn.disabled = true;
        sendBtn.textContent = 'ì „ì†¡ì¤‘...';
        input.disabled = true;
      } else {
        sendBtn.disabled = false;
        sendBtn.textContent = 'ë³´ë‚´ê¸°';
        input.disabled = false;
        input.focus();
      }
    }

    // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” ê°„ë‹¨í•œ í•¨ìˆ˜
    function parseMarkdown(text) {
      return text
      // ì½”ë“œ ë¸”ë¡ (```)
      .replace(/```(\w+)?\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
      // ì¸ë¼ì¸ ì½”ë“œ (`)
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      // êµµì€ ê¸€ì”¨ (**)
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      // ê¸°ìš¸ì„ (*)
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      // ì œëª© (###, ##, #)
      .replace(/^### (.*$)/gm, '<h3>$1</h3>')
      .replace(/^## (.*$)/gm, '<h2>$1</h2>')
      .replace(/^# (.*$)/gm, '<h1>$1</h1>')
      // ìˆœì„œ ì—†ëŠ” ëª©ë¡ (- ë˜ëŠ” *)
      .replace(/^[\-\*] (.+)$/gm, '<li>$1</li>')
      // ìˆœì„œ ìˆëŠ” ëª©ë¡ (1. 2. ë“±)
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
      // ë¸”ë¡ ì¸ìš© (>)
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      // ì¤„ë°”ê¿ˆ
      .replace(/\n/g, '<br>');
    }

    // li íƒœê·¸ë“¤ì„ ulë¡œ ê°ì‹¸ê¸°
    function wrapListItems(html) {
      // ì—°ì†ëœ li íƒœê·¸ë“¤ì„ ulë¡œ ê°ì‹¸ê¸°
      return html.replace(/(<li>.*?<\/li>(?:\s*<br>\s*<li>.*?<\/li>)*)/g, '<ul>$1</ul>')
      .replace(/<br>\s*(<li>)/g, '$1')  // ul ë‚´ë¶€ì˜ ë¶ˆí•„ìš”í•œ br ì œê±°
      .replace(/(<\/li>)\s*<br>/g, '$1'); // li ë’¤ì˜ ë¶ˆí•„ìš”í•œ br ì œê±°
    }

    // ì‹¤ì œ í‚¤ì›Œë“œ ì „ì†¡ ë¡œì§
    function sendKeyword(keyword) {
      const responseElement = document.getElementById('chatbot-response');
      responseElement.innerHTML = 'ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘<span class="loading-dots"></span>';

      setLoading(true);

      // localStorageì— ì €ì¥ (ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•  ë•Œë§Œ)
      try {
        localStorage.setItem('lastKeyword', keyword);
      } catch (e) {
        // localStorageë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì—ì„œëŠ” ë¬´ì‹œ
        console.log('localStorage not available');
      }

      fetch('/chatbot/message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ keyword })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.response) {
          // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
          let htmlContent = parseMarkdown(data.response);
          htmlContent = wrapListItems(htmlContent);
          responseElement.innerHTML = htmlContent;

          // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
          responseElement.scrollTop = responseElement.scrollHeight;
        } else {
          responseElement.innerHTML = 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        let errorMessage = '';
        if (error.name === 'TypeError') {
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš” ğŸŒ';
        } else if (error.message.includes('500')) {
          errorMessage = 'ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš” ğŸ”§';
        } else {
          errorMessage = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš” ğŸ˜¥';
        }
        responseElement.innerHTML = errorMessage;
      })
      .finally(() => {
        setLoading(false);
      });
    }

    // ë§ˆì§€ë§‰ í‚¤ì›Œë“œ ë³µì› (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    window.addEventListener('DOMContentLoaded', () => {
      try {
        const last = localStorage.getItem('lastKeyword');
        if (last) {
          // ìë™ìœ¼ë¡œ ë§ˆì§€ë§‰ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì§€ ì•Šê³ , ì…ë ¥ì°½ì—ë§Œ ì„¤ì •
          // sendKeyword(last);
        }
      } catch (e) {
        console.log('localStorage not available');
      }
    });
  </script>
</div>