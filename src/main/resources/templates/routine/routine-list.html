<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="_csrf" th:content="${_csrf?.token}" />
  <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
  <title>데일리 루틴</title>

  <!-- ✅ 공통 스타일 -->
  <link rel="stylesheet" th:href="@{/css/fragment/header.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/sidenav.css}"/>
  <link rel="stylesheet" th:href="@{/css/fragment/chatbot.css}"/>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f8f9fa;
      min-height: 100vh;
    }



    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }



    .nav-item:hover {
      background-color: #f3f4f6;
      transform: translateX(4px);
    }

    .nav-item.active {
      background-color: #f0f4ff;
      color: #667eea;
      font-weight: 600;
    }



    .nav-item.active .nav-indicator {
      opacity: 1;
    }



    /* 메인 컨텐츠 스타일 */
    main {
      margin-left: 280px;
      margin-top: 70px;
      padding: 30px;
      min-height: calc(100vh - 70px);
      transition: margin-left 0.3s ease;
    }

    .routine-wrapper {
      background-color: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 1200px;
      margin: 0 auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .routine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f3f4f6;
    }

    .routine-header h2 {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    .date-filter {
      margin-bottom: 24px;
    }

    .date-filter label {
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      margin-right: 12px;
    }

    .date-filter input[type="date"] {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .date-filter input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }

    /* 고정 루틴 섹션 */
    .fixed-routines-section {
      margin-bottom: 32px;
    }

    .fixed-routines-section h3 {
      font-size: 20px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
    }

    .fixed-routines-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 16px;
    }

    .fixed-routine-card {
      background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
      border: 2px solid #c7d2fe;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .fixed-routine-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
    }

    .fixed-routine-info {
      flex: 1;
    }

    .fixed-routine-title {
      font-size: 16px;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .fixed-routine-description {
      font-size: 14px;
      color: #6b7280;
    }

    .fixed-routine-start-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .fixed-routine-start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* 루틴 섹션 통합 */
    .all-routines-section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #374151;
      margin: 0;
    }

    .add-routine-btn {
      background-color: #10b981;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .add-routine-btn:hover {
      background-color: #059669;
      transform: translateY(-1px);
    }

    .routine-item {
      background-color: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .routine-item:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* 완료된 루틴 스타일 */
    .routine-item.completed .routine-title {
      text-decoration: line-through;
      color: #6b7280;
    }

    /* 쉬어가기 루틴 스타일 - 배경색 제거 */

    .routine-info {
      flex: 1;
    }

    .routine-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .routine-category {
      font-size: 14px;
      color: #6b7280;
    }

    .routine-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* 버튼 스타일 통합 */
    .routine-btn {
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    /* 시작하기 버튼 */
    .routine-btn.start {
      background-color: #667eea;
      color: white;
    }

    .routine-btn.start:hover {
      background-color: #5a67d8;
      transform: translateY(-1px);
    }

    /* 완료 버튼 */
    .routine-btn.completed {
      background-color: #9ca3af;
      color: white;
    }

    /* 쉬어가기 버튼 */
    .routine-btn.passed {
      background-color: #d1d5db;
      color: white;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    .menu-button:hover {
      background-color: #f3f4f6;
    }

    .menu-box {
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 10;
      min-width: 120px;
      overflow: hidden;
    }

    .menu-box div {
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .menu-box div:hover {
      background-color: #f3f4f6;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .empty-state p {
      margin-bottom: 12px;
      font-size: 16px;
    }

    /* 모달 스타일 */
    #routineModal, #codingTestModal, #interviewModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    #routineModal h3, #codingTestModal h3, #interviewModal h3 {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 24px;
    }

    #routineModal input, #routineModal select, #routineModal textarea,
    #codingTestModal input, #codingTestModal select, #codingTestModal textarea,
    #interviewModal input, #interviewModal select, #interviewModal textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    #routineModal input:focus, #routineModal select:focus, #routineModal textarea:focus,
    #codingTestModal input:focus, #codingTestModal select:focus, #codingTestModal textarea:focus,
    #interviewModal input:focus, #interviewModal select:focus, #interviewModal textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    #routineModal textarea, #codingTestModal textarea, #interviewModal textarea {
      min-height: 100px;
      resize: vertical;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }

    .button-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-group button.cancel {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    .button-group button.cancel:hover {
      background-color: #d1d5db;
    }

    .button-group button.submit {
      background-color: #667eea;
      color: white;
    }

    .button-group button.submit:hover {
      background-color: #5a67d8;
    }

    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      main {
        margin-left: 0;
        padding: 20px;
      }

      .sidebar-toggle {
        display: block;
      }

      .fixed-routines-container {
        grid-template-columns: 1fr;
      }

      .routine-wrapper {
        padding: 20px;
      }

      .logo-subtitle {
        display: none;
      }

      .user-details {
        display: none;
      }
    }
  </style>
</head>
<body>
<!--알림 -->
<th:block th:replace="fragments/common/alert-script :: alert-script"></th:block>

<!-- 헤더 -->
<header th:replace="fragments/header/header :: header"></header>

<!-- 사이드바 -->
<aside th:replace="fragments/sidenav/user/user-sidenav :: sidebar"></aside>

<!-- 메인 컨텐츠 -->
<main>
  <div class="routine-wrapper">
    <div class="routine-header">
      <h2>데일리 루틴</h2>
    </div>

    <div class="date-filter">
      <form id="dateFilterForm" action="/routines" method="get">
        <label for="dateFilter">날짜 선택 : </label>
        <input type="date" id="dateFilter" name="date"
               th:value="${#temporals.format(selectedDate, 'yyyy-MM-dd')}"
               onchange="this.form.submit()">
      </form>
    </div>

    <!-- 고정 루틴 섹션 - 가로 배치 -->
    <div class="fixed-routines-section">
      <h3>필수 루틴</h3>

      <div class="fixed-routines-container">
        <div class="fixed-routine-card">
          <div class="fixed-routine-content">
            <div class="fixed-routine-info">
              <span class="fixed-routine-title">코딩테스트 준비</span>
              <span class="fixed-routine-description">알고리즘 및 코딩테스트 대비</span>
            </div>
          </div>
          <button class="fixed-routine-start-btn" onclick="openCodingTestModal()">추가하기</button>
        </div>

        <div class="fixed-routine-card">
          <div class="fixed-routine-content">
            <div class="fixed-routine-info">
              <span class="fixed-routine-title">면접 준비</span>
              <span class="fixed-routine-description">기술 면접 질문 연습</span>
            </div>
          </div>
          <button class="fixed-routine-start-btn" onclick="openInterviewModal()">추가하기</button>
        </div>
      </div>
    </div>

    <!-- 통합된 루틴 섹션 -->
    <div class="all-routines-section">
      <div class="section-header">
        <h3>데일리 루틴</h3>
        <button class="add-routine-btn" onclick="openModal()">+ 추가</button>
      </div>

      <!-- 활성 루틴 목록 -->
      <div th:if="${activeRoutines != null and !activeRoutines.isEmpty()}">
        <div th:each="routine : ${activeRoutines}" class="routine-item">
          <div class="routine-left">
            <div class="routine-info">
              <span class="routine-title" th:text="${routine.title}">데일리 루틴 1</span>
              <span class="routine-category" th:text="${routine.category}">카테고리</span>
            </div>
          </div>
          <div class="routine-right">
            <button class="routine-btn start" th:onclick="'location.href=\'/routines/' + ${routine.id} + '/timer\''">시작하기</button>
            <div style="position: relative;">
              <button class="menu-button">⋯</button>
              <div class="menu-box">
                <div th:onclick="'editRoutine(' + ${routine.id} + ')'">수정</div>
                <div th:onclick="'deleteRoutine(' + ${routine.id} + ')'">삭제</div>
                <div th:onclick="'skipRoutine(' + ${routine.id} + ')'">쉬어가기</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 쉬어가기 루틴 목록 -->
      <div th:if="${passedRoutines != null and !passedRoutines.isEmpty()}">
        <div th:each="routine : ${passedRoutines}" class="routine-item passed">
          <div class="routine-left">
            <div class="routine-info">
              <span class="routine-title">
                <span style="color: #888;">(PASS)</span> <span th:text="${routine.title}">쉬어가기 루틴</span>
              </span>
              <span class="routine-category" th:text="${routine.category}">카테고리</span>
            </div>
          </div>
          <div class="routine-right">
            <button class="routine-btn passed">쉬어가기</button>
            <div style="position: relative;">
              <button class="menu-button">⋯</button>
              <div class="menu-box">
                <div th:onclick="'cancelPass(' + ${routine.id} + ')'">쉬어가기 취소</div>
                <div th:onclick="'deleteRoutine(' + ${routine.id} + ')'">삭제</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 완료된 루틴 목록 -->
      <div th:if="${completedRoutines != null and !completedRoutines.isEmpty()}">
        <div th:each="routine : ${completedRoutines}" class="routine-item completed">
          <div class="routine-left">
            <div class="routine-info">
              <span class="routine-title" th:text="${routine.title}">완료된 루틴 1</span>
              <span class="routine-category" th:text="${routine.category}">카테고리</span>
            </div>
          </div>
          <div class="routine-right">
            <button class="routine-btn completed">완료</button>
            <div style="position: relative;">
              <button class="menu-button">⋯</button>
              <div class="menu-box">
                <!-- 코딩테스트 루틴인 경우 정보보기 추가 -->
                <div th:if="${routine.category != null and #strings.startsWith(routine.category, '코딩테스트 준비')}"
                     th:onclick="'viewCodingReview(' + ${routine.id} + ')'">정보보기</div>
                <!-- 면접준비 루틴인 경우 정보보기 추가 -->
                <div th:if="${routine.category != null and #strings.startsWith(routine.category, '면접준비')}"
                     th:onclick="'viewInterviewReview(' + ${routine.id} + ')'">정보보기</div>
                <div th:onclick="'cancelComplete(' + ${routine.id} + ')'">완료 취소</div>
                <div th:onclick="'deleteRoutine(' + ${routine.id} + ')'">삭제</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 루틴이 없을 때 보여줄 빈 상태 -->
      <div th:if="${(activeRoutines == null or activeRoutines.isEmpty()) and (passedRoutines == null or passedRoutines.isEmpty()) and (completedRoutines == null or completedRoutines.isEmpty())}" class="empty-state">
        <p>등록된 데일리 루틴이 없습니다.</p>
        <p>오늘의 루틴을 추가해 보세요!</p>
      </div>
    </div>
  </div>
</main>

<!-- 모달 배경 -->
<div class="modal-backdrop" id="modalBackdrop"></div>

<!-- 일반 루틴 추가/수정 모달 -->
<div id="routineModal">
  <h3>루틴 추가</h3>
  <form id="routineForm" th:action="@{/routines}" method="post">
    <input type="hidden" id="routineId" name="id" />
    <input type="text" name="category" placeholder="카테고리 입력" required />
    <input type="text" name="title" placeholder="루틴 제목" required />
    <textarea name="description" placeholder="상세 설명"></textarea>
    <input type="number" name="focusTime" placeholder="집중 시간(분)" min="1" max="180" required />
    <input type="number" name="breakTime" placeholder="휴식 시간(분)" min="1" max="60" value="5" required />
    <div class="button-group">
      <button type="button" class="cancel" onclick="closeModal()">취소</button>
      <button type="submit" class="submit">저장</button>
    </div>
  </form>
</div>

<!-- 코딩테스트 준비 루틴 모달 -->
<div id="codingTestModal">
  <h3>코딩테스트 준비 루틴 추가</h3>
  <form id="codingTestForm" th:action="@{/routines}" method="post">
    <select name="problemType" required>
      <option value="">문제 종류 선택</option>
      <option value="자료구조">자료구조</option>
      <option value="BFS/DFS">BFS/DFS</option>
      <option value="구현">구현</option>
      <option value="다익스트라">다익스트라</option>
      <option value="트리">트리</option>
      <option value="다이나믹 프로그래밍">다이나믹 프로그래밍</option>
      <option value="탐색">탐색</option>
      <option value="그리디">그리디</option>
      <option value="기타">기타</option>
    </select>
    <textarea name="description" placeholder="상세 설명"></textarea>
    <input type="number" name="focusTime" placeholder="집중 시간(분)" min="1" max="180" required />
    <input type="number" name="breakTime" placeholder="휴식 시간(분)" min="1" max="60" value="5" required />
    <input type="hidden" name="category" id="codingTestCategory" />
    <input type="hidden" name="title" id="codingTestTitle" />
    <div class="button-group">
      <button type="button" class="cancel" onclick="closeCodingTestModal()">취소</button>
      <button type="submit" class="submit">저장</button>
    </div>
  </form>
</div>

<!-- 면접 준비 루틴 모달 -->
<div id="interviewModal">
  <h3>면접 준비 루틴 추가</h3>
  <form id="interviewForm" th:action="@{/routines}" method="post">
    <input type="hidden" id="interviewTitle" name="title" />
    <input type="hidden" id="interviewCategory" name="category" />

    <select name="techType" required>
      <option value="">기술 종류 선택</option>
      <option value="알고리즘">알고리즘</option>
      <option value="자료구조">자료구조</option>
      <option value="데이터베이스">데이터베이스</option>
      <option value="운영체제">운영체제</option>
      <option value="네트워크">네트워크</option>
      <option value="컴퓨터구조">컴퓨터구조</option>
    </select>

    <textarea name="description" placeholder="상세 설명 (선택사항)"></textarea>
    <input type="number" name="focusTime" placeholder="집중 시간(분)" min="1" max="180"  required />
    <input type="number" name="breakTime" placeholder="휴식 시간(분)" min="1" max="60" value="5" required />

    <div class="button-group">
      <button type="button" class="cancel" onclick="closeInterviewModal()">취소</button>
      <button type="submit" class="submit">저장</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 메뉴 버튼 이벤트 설정
    const menuButtons = document.querySelectorAll('.menu-button');
    menuButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const menuBox = this.nextElementSibling;

        // 다른 열린 메뉴 닫기
        document.querySelectorAll('.menu-box').forEach(box => {
          if (box !== menuBox) {
            box.style.display = 'none';
          }
        });

        // 현재 메뉴 토글
        menuBox.style.display = menuBox.style.display === 'block' ? 'none' : 'block';
      });
    });

    // 문서 클릭 시 열린 메뉴 닫기
    document.addEventListener('click', function() {
      document.querySelectorAll('.menu-box').forEach(box => {
        box.style.display = 'none';
      });
    });
  });

  // 모달 배경 요소
  const modalBackdrop = document.getElementById('modalBackdrop');

  function openModal() {
    // 폼 초기화
    document.getElementById('routineForm').reset();
    document.getElementById('routineId').value = '';
    document.getElementById('routineModal').style.display = 'block';
    modalBackdrop.style.display = 'block';
  }

  function closeModal() {
    document.getElementById('routineModal').style.display = 'none';
    modalBackdrop.style.display = 'none';
  }

  function openCodingTestModal() {
    document.getElementById('codingTestForm').reset();
    document.getElementById('codingTestModal').style.display = 'block';
    modalBackdrop.style.display = 'block';
  }

  function closeCodingTestModal() {
    document.getElementById('codingTestModal').style.display = 'none';
    modalBackdrop.style.display = 'none';
  }

  function openInterviewModal() {
    document.getElementById('interviewForm').reset();
    document.getElementById('interviewModal').style.display = 'block';
    modalBackdrop.style.display = 'block';
  }

  function closeInterviewModal() {
    document.getElementById('interviewModal').style.display = 'none';
    modalBackdrop.style.display = 'none';
  }

  // 모달 배경 클릭 시 모달 닫기
  modalBackdrop.addEventListener('click', function() {
    closeModal();
    closeCodingTestModal();
    closeInterviewModal();
  });

  // 코딩테스트 폼 제출 시
  document.getElementById('codingTestForm').addEventListener('submit', function(e) {
    const problemType = document.querySelector('select[name="problemType"]').value;
    if (problemType) {
      document.getElementById('codingTestTitle').value = `코딩테스트 준비 - ${problemType}`;
      document.getElementById('codingTestCategory').value = `코딩테스트 준비 - ${problemType}`;
    }
  });

  // 면접준비 폼 제출 시
  document.getElementById('interviewForm').addEventListener('submit', function(e) {
    const techType = document.querySelector('select[name="techType"]').value;
    if (techType) {
      document.getElementById('interviewTitle').value = `면접준비 - ${techType}`;
      document.getElementById('interviewCategory').value = `면접준비 - ${techType}`;
    }
  });

  // 코딩테스트 회고 정보보기
  function viewCodingReview(routineId) {
    location.href = '/routines/' + routineId + '/coding-review';
  }

  // 면접준비 회고 정보보기
  function viewInterviewReview(routineId) {
    location.href = '/routines/' + routineId + '/interview-review';
  }

  function editRoutine(routineId) {
    fetch(`/routines/${routineId}/edit`)
    .then(response => response.json())
    .then(data => {
      // 모달 제목 변경
      document.querySelector('#routineModal h3').textContent = '루틴 수정';

      // 폼 데이터 채우기
      document.getElementById('routineId').value = data.id;
      document.querySelector('input[name="category"]').value = data.category || '';
      document.querySelector('input[name="title"]').value = data.title || '';
      document.querySelector('textarea[name="description"]').value = data.description || '';
      document.querySelector('input[name="focusTime"]').value = data.focusTime || '';
      document.querySelector('input[name="breakTime"]').value = data.breakTime || 5;

      // 폼 액션 및 메서드 변경
      const form = document.getElementById('routineForm');
      form.action = `/routines/${routineId}`;

      // CSRF 토큰 추가
      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      let csrfInput = form.querySelector('input[name="_csrf"]');
      if (!csrfInput) {
        csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
      } else {
        csrfInput.value = csrfToken;
      }

      // hidden input 추가
      let methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      methodInput.value = 'PATCH';
      form.appendChild(methodInput);

      // 모달 표시
      document.getElementById('routineModal').style.display = 'block';
      modalBackdrop.style.display = 'block';
    })
    .catch(error => {
      console.error('Error:', error);
      alert('루틴 정보를 불러오는 데 실패했습니다.');
    });
  }

  function deleteRoutine(routineId) {
    if (confirm('정말 이 루틴을 삭제하시겠습니까?')) {
      // CSRF 토큰 가져오기
      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

      fetch(`/routines/${routineId}`, {
        method: 'DELETE',
        headers: {
          [csrfHeader]: csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 성공 시 해당 요소만 DOM에서 제거
          const routineElement = document.querySelector(`.routine-item:has([onclick*="deleteRoutine(${routineId})"])`);
          if (routineElement) {
            routineElement.remove();
            showNotification(data.message);
            checkEmptySections();
          } else {
            window.location.reload();
          }
        } else {
          alert(data.message || '루틴 삭제에 실패했습니다.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('루틴 삭제 중 오류가 발생했습니다.');
      });
    }
  }

  function skipRoutine(routineId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/routines/${routineId}/skip`;

    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);

    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
  }

  function cancelPass(routineId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/routines/${routineId}/cancel`;

    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);

    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
  }

  function cancelComplete(routineId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/routines/${routineId}/cancel`;

    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'PATCH';
    form.appendChild(methodInput);

    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
  }

  function showNotification(message) {
    // 알림 표시 로직
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background-color: #10b981;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transition = 'opacity 0.5s';
      setTimeout(() => notification.remove(), 500);
    }, 3000);
  }

  function checkEmptySections() {
    const allRoutines = document.querySelectorAll('.all-routines-section .routine-item');
    const emptyStateExists = document.querySelector('.empty-state');

    if (allRoutines.length === 0 && !emptyStateExists) {
      const emptyState = document.createElement('div');
      emptyState.className = 'empty-state';
      emptyState.innerHTML = '<p>등록된 데일리 루틴이 없습니다.</p><p>오늘의 루틴을 추가해 보세요!</p>';

      const allRoutinesSection = document.querySelector('.all-routines-section');
      allRoutinesSection.appendChild(emptyState);
    }
  }
</script>

<th:block th:replace="fragments/common/chatbot-modal :: chatbot"></th:block>
</body>
</html>